# UDPç«¯å£å˜åŒ–é—®é¢˜ä¿®å¤

## é—®é¢˜æè¿°

åœ¨AIå¯¹è¯ç³»ç»Ÿä¸­ï¼Œå®¢æˆ·ç«¯çš„UDPç«¯å£ä¼šåœ¨ç½‘ç»œå±‚é¢å‘ç”Ÿå˜åŒ–ï¼ˆä¾‹å¦‚ä»37215å˜ä¸º54160ï¼‰ï¼Œè¿™æ˜¯æ­£å¸¸çš„ç½‘ç»œè¡Œä¸ºï¼Œç‰¹åˆ«æ˜¯åœ¨NATç¯å¢ƒä¸‹ã€‚ä½†æ˜¯æœåŠ¡å™¨ä½¿ç”¨`(IP, port)`ä½œä¸ºå®¢æˆ·ç«¯å”¯ä¸€æ ‡è¯†ï¼Œå¯¼è‡´ç«¯å£å˜åŒ–æ—¶è¢«è¯¯è®¤ä¸ºæ˜¯æ–°å®¢æˆ·ç«¯ï¼Œä»è€Œé‡å¤å‘é€å¼€åœºç™½ã€‚

## é—®é¢˜æ ¹æº

1. **æœåŠ¡å™¨ä½¿ç”¨UDPåœ°å€å…ƒç»„ä½œä¸ºå®¢æˆ·ç«¯æ ‡è¯†**ï¼š`(IP, port)`
2. **UDPç«¯å£åœ¨ç½‘ç»œå±‚é¢ä¼šå˜åŒ–**ï¼šè¿™æ˜¯ç½‘ç»œæ ˆçš„æ­£å¸¸è¡Œä¸º
3. **ä¸¤ä¸ªè§¦å‘å¼€åœºç™½çš„åœ°æ–¹**ï¼š
   - å¤„ç†`CONTROL_HELLO`æ§åˆ¶åŒ…æ—¶
   - å¤„ç†`COMPRESSION_ADPCM`éŸ³é¢‘æ•°æ®æ—¶
4. **ç«¯å£å˜åŒ–å¯¼è‡´é‡å¤å¼€åœºç™½**ï¼šæ–°ç«¯å£è¢«è®¤ä¸ºæ˜¯æ–°å®¢æˆ·ç«¯

## è§£å†³æ–¹æ¡ˆ

### 1. ä½¿ç”¨IPä½œä¸ºå®¢æˆ·ç«¯å”¯ä¸€æ ‡è¯†

- æ·»åŠ `client_welcomed_ips`é›†åˆï¼Œä½¿ç”¨IPè€Œä¸æ˜¯`(IP, port)`
- æ·»åŠ `client_ip_to_current_addr`æ˜ å°„ï¼Œè·Ÿè¸ªæ¯ä¸ªIPçš„å½“å‰åœ°å€

### 2. ç«¯å£å˜åŒ–æ£€æµ‹å’ŒçŠ¶æ€è¿ç§»

æ·»åŠ äº†ä¸¤ä¸ªå…³é”®æ–¹æ³•ï¼š

#### `_handle_client_address_change(new_addr)`
- æ£€æµ‹åŒä¸€IPçš„ç«¯å£å˜åŒ–
- è§¦å‘çŠ¶æ€è¿ç§»
- æ›´æ–°IPåˆ°åœ°å€çš„æ˜ å°„

#### `_migrate_client_state(old_addr, new_addr)`
- è¿ç§»æ‰€æœ‰å®¢æˆ·ç«¯çŠ¶æ€ï¼š
  - `client_codecs` - ADPCMç¼–è§£ç å™¨çŠ¶æ€
  - `client_queues` - éŸ³é¢‘é˜Ÿåˆ—
  - `client_handlers` - éŸ³é¢‘å¤„ç†å™¨
  - `client_ai` - AIå¯¹è¯å†å²
  - `client_last_activity` - æœ€åæ´»åŠ¨æ—¶é—´
  - `client_sessions` - ä¼šè¯ID
  - `client_chunk_counters` - chunkè®¡æ•°å™¨
  - `client_interrupt_cooldown` - æ‰“æ–­å†·å´
  - `client_states` - ç»Ÿä¸€çŠ¶æ€ç®¡ç†
  - `fragment_cache` - åˆ†ç‰‡ç¼“å­˜
- æ›´æ–°WebSocketç»‘å®š

### 3. ä¿®æ”¹å…³é”®é€»è¾‘

#### åœ¨`_recv_loop`ä¸­çš„ADPCMå¤„ç†ï¼š
```python
# å¤„ç†åœ°å€å˜åŒ–ï¼ˆç«¯å£å¯èƒ½å˜åŒ–ï¼‰
addr = self._handle_client_address_change(addr)

# ä½¿ç”¨IPä½œä¸ºå®¢æˆ·ç«¯æ ‡è¯†
client_ip = addr[0]
if client_ip not in self.client_welcomed_ips:
    self.client_welcomed_ips.add(client_ip)
    self._send_opening_statement(addr)
```

#### åœ¨`_recv_loop`ä¸­çš„HELLOå¤„ç†ï¼š
```python
# å¤„ç†åœ°å€å˜åŒ–ï¼ˆç«¯å£å¯èƒ½å˜åŒ–ï¼‰
addr = self._handle_client_address_change(addr)

# ä½¿ç”¨IPä½œä¸ºå®¢æˆ·ç«¯æ ‡è¯†
client_ip = addr[0]
if client_ip not in self.client_welcomed_ips:
    self.client_welcomed_ips.add(client_ip)
    self._send_opening_statement(addr)
```

### 4. æ¸…ç†é€»è¾‘æ›´æ–°

- `reset_client_session`ï¼šåŒæ—¶æ¸…ç†IPçº§åˆ«çš„welcomedæ ‡è®°
- `cleanup_inactive_clients`ï¼šæ¸…ç†IPæ˜ å°„å’Œwelcomedæ ‡è®°

## æµ‹è¯•éªŒè¯

åˆ›å»ºäº†`test_port_migration.py`æµ‹è¯•è„šæœ¬ï¼ŒéªŒè¯ï¼š
- âœ… ç«¯å£å˜åŒ–æ£€æµ‹
- âœ… çŠ¶æ€è¿ç§»å®Œæ•´æ€§
- âœ… IPçº§åˆ«welcomedé€»è¾‘
- âœ… å¤šæ¬¡ç«¯å£å˜åŒ–å¤„ç†

## é¢„æœŸæ•ˆæœ

1. **è§£å†³é‡å¤å¼€åœºç™½é—®é¢˜**ï¼šåŒä¸€IPçš„ç«¯å£å˜åŒ–ä¸ä¼šè§¦å‘æ–°çš„å¼€åœºç™½
2. **ä¿æŒä¼šè¯è¿ç»­æ€§**ï¼šæ‰€æœ‰å®¢æˆ·ç«¯çŠ¶æ€åœ¨ç«¯å£å˜åŒ–æ—¶æ— ç¼è¿ç§»
3. **æ”¯æŒç½‘ç»œç¯å¢ƒå˜åŒ–**ï¼šé€‚åº”NATã€ä»£ç†ç­‰ç½‘ç»œç¯å¢ƒçš„ç«¯å£å˜åŒ–
4. **å‘åå…¼å®¹**ï¼šä¸å½±å“ç°æœ‰çš„å•ç«¯å£å®¢æˆ·ç«¯

## å…³é”®æ”¹è¿›ç‚¹

- ğŸ¯ **æ ¹æœ¬è§£å†³**ï¼šä½¿ç”¨IPè€Œä¸æ˜¯ç«¯å£ä½œä¸ºå®¢æˆ·ç«¯æ ‡è¯†
- ğŸ”„ **æ— ç¼è¿ç§»**ï¼šç«¯å£å˜åŒ–æ—¶è‡ªåŠ¨è¿ç§»æ‰€æœ‰çŠ¶æ€
- ğŸ›¡ï¸ **ä¼šè¯ä¿æŠ¤**ï¼šä¿æŒAIå¯¹è¯çš„è¿ç»­æ€§
- ğŸ“¡ **ç½‘ç»œé€‚åº”**ï¼šé€‚åº”å„ç§ç½‘ç»œç¯å¢ƒçš„ç«¯å£å˜åŒ–è¡Œä¸º
