# UDP ç«¯å£å˜åŒ–é—®é¢˜ä¿®å¤

## é—®é¢˜æè¿°

åœ¨ AI å¯¹è¯ç³»ç»Ÿä¸­å‘ç°å®¢æˆ·ç«¯ UDP ç«¯å£é¢‘ç¹å˜åŒ–çš„é—®é¢˜ï¼Œå¯¼è‡´æœåŠ¡å™¨è¯¯è®¤ä¸ºæ˜¯æ–°å®¢æˆ·ç«¯è€Œé‡å¤å‘é€å¼€åœºç™½ã€‚

### é—®é¢˜ç°è±¡

- å®¢æˆ·ç«¯ UDP ç«¯å£åœ¨æ¯æ¬¡æ•°æ®å‘é€æ—¶éƒ½å¯èƒ½å˜åŒ–ï¼ˆå¦‚ï¼š52498 -> 36105 -> 57772 -> 51202...ï¼‰
- å˜åŒ–é¢‘ç‡æé«˜ï¼Œå‡ ä¹æ¯ä¸ªæ•°æ®åŒ…éƒ½ä½¿ç”¨ä¸åŒç«¯å£
- å³ä½¿åœ¨æœ¬åœ°å›ç¯åœ°å€ï¼ˆ127.0.0.1ï¼‰ä¹Ÿå‡ºç°æ­¤é—®é¢˜

### æ ¹æœ¬åŸå› åˆ†æ

ç»è¿‡æ·±å…¥åˆ†æå‘ç°ï¼Œé—®é¢˜ä¸åœ¨ç½‘ç»œå±‚é¢ï¼Œè€Œåœ¨äº**å®¢æˆ·ç«¯ UDP socket æ²¡æœ‰ç»‘å®šåˆ°å›ºå®šç«¯å£**ï¼š

1. **Windows UDP ç«¯å£åˆ†é…è¡Œä¸º**ï¼š

   - å®¢æˆ·ç«¯åˆ›å»º UDP socket ä½†æœªè°ƒç”¨ bind()æˆ– connect()
   - Windows ç³»ç»Ÿåœ¨æ¯æ¬¡ sendto()è°ƒç”¨æ—¶å¯èƒ½åˆ†é…æ–°çš„æºç«¯å£
   - é«˜é¢‘å‘é€ï¼ˆéŸ³é¢‘æ•°æ®æ¯ç§’çº¦ 31 æ¬¡ï¼‰åŠ å‰§äº†ç«¯å£å˜åŒ–

2. **UDP æ— è¿æ¥ç‰¹æ€§**ï¼š
   - æ¯æ¬¡ sendto()éƒ½æ˜¯ç‹¬ç«‹æ“ä½œ
   - æ“ä½œç³»ç»Ÿå¯èƒ½ä¸ºæ¯æ¬¡å‘é€åˆ†é…æ–°ç«¯å£
   - è¿™æ˜¯ Windows ç‰¹æœ‰çš„ UDP ç«¯å£åˆ†é…ç­–ç•¥

## é—®é¢˜æ ¹æº

1. **æœåŠ¡å™¨ä½¿ç”¨ UDP åœ°å€å…ƒç»„ä½œä¸ºå®¢æˆ·ç«¯æ ‡è¯†**ï¼š`(IP, port)`
2. **UDP ç«¯å£åœ¨ç½‘ç»œå±‚é¢ä¼šå˜åŒ–**ï¼šè¿™æ˜¯ç½‘ç»œæ ˆçš„æ­£å¸¸è¡Œä¸º
3. **ä¸¤ä¸ªè§¦å‘å¼€åœºç™½çš„åœ°æ–¹**ï¼š
   - å¤„ç†`CONTROL_HELLO`æ§åˆ¶åŒ…æ—¶
   - å¤„ç†`COMPRESSION_ADPCM`éŸ³é¢‘æ•°æ®æ—¶
4. **ç«¯å£å˜åŒ–å¯¼è‡´é‡å¤å¼€åœºç™½**ï¼šæ–°ç«¯å£è¢«è®¤ä¸ºæ˜¯æ–°å®¢æˆ·ç«¯

## è§£å†³æ–¹æ¡ˆ

### 1. ä½¿ç”¨ IP ä½œä¸ºå®¢æˆ·ç«¯å”¯ä¸€æ ‡è¯†

- æ·»åŠ `client_welcomed_ips`é›†åˆï¼Œä½¿ç”¨ IP è€Œä¸æ˜¯`(IP, port)`
- æ·»åŠ `client_ip_to_current_addr`æ˜ å°„ï¼Œè·Ÿè¸ªæ¯ä¸ª IP çš„å½“å‰åœ°å€

### 2. ç«¯å£å˜åŒ–æ£€æµ‹å’ŒçŠ¶æ€è¿ç§»

æ·»åŠ äº†ä¸¤ä¸ªå…³é”®æ–¹æ³•ï¼š

#### `_handle_client_address_change(new_addr)`

- æ£€æµ‹åŒä¸€ IP çš„ç«¯å£å˜åŒ–
- è§¦å‘çŠ¶æ€è¿ç§»
- æ›´æ–° IP åˆ°åœ°å€çš„æ˜ å°„

#### `_migrate_client_state(old_addr, new_addr)`

- è¿ç§»æ‰€æœ‰å®¢æˆ·ç«¯çŠ¶æ€ï¼š
  - `client_codecs` - ADPCM ç¼–è§£ç å™¨çŠ¶æ€
  - `client_queues` - éŸ³é¢‘é˜Ÿåˆ—
  - `client_handlers` - éŸ³é¢‘å¤„ç†å™¨
  - `client_ai` - AI å¯¹è¯å†å²
  - `client_last_activity` - æœ€åæ´»åŠ¨æ—¶é—´
  - `client_sessions` - ä¼šè¯ ID
  - `client_chunk_counters` - chunk è®¡æ•°å™¨
  - `client_interrupt_cooldown` - æ‰“æ–­å†·å´
  - `client_states` - ç»Ÿä¸€çŠ¶æ€ç®¡ç†
  - `fragment_cache` - åˆ†ç‰‡ç¼“å­˜
- æ›´æ–° WebSocket ç»‘å®š

### 3. ä¿®æ”¹å…³é”®é€»è¾‘

#### åœ¨`_recv_loop`ä¸­çš„ ADPCM å¤„ç†ï¼š

```python
# å¤„ç†åœ°å€å˜åŒ–ï¼ˆç«¯å£å¯èƒ½å˜åŒ–ï¼‰
addr = self._handle_client_address_change(addr)

# ä½¿ç”¨IPä½œä¸ºå®¢æˆ·ç«¯æ ‡è¯†
client_ip = addr[0]
if client_ip not in self.client_welcomed_ips:
    self.client_welcomed_ips.add(client_ip)
    self._send_opening_statement(addr)
```

#### åœ¨`_recv_loop`ä¸­çš„ HELLO å¤„ç†ï¼š

```python
# å¤„ç†åœ°å€å˜åŒ–ï¼ˆç«¯å£å¯èƒ½å˜åŒ–ï¼‰
addr = self._handle_client_address_change(addr)

# ä½¿ç”¨IPä½œä¸ºå®¢æˆ·ç«¯æ ‡è¯†
client_ip = addr[0]
if client_ip not in self.client_welcomed_ips:
    self.client_welcomed_ips.add(client_ip)
    self._send_opening_statement(addr)
```

### 4. æ¸…ç†é€»è¾‘æ›´æ–°

- `reset_client_session`ï¼šåŒæ—¶æ¸…ç† IP çº§åˆ«çš„ welcomed æ ‡è®°
- `cleanup_inactive_clients`ï¼šæ¸…ç† IP æ˜ å°„å’Œ welcomed æ ‡è®°

## æµ‹è¯•éªŒè¯

åˆ›å»ºäº†`test_port_migration.py`æµ‹è¯•è„šæœ¬ï¼ŒéªŒè¯ï¼š

- âœ… ç«¯å£å˜åŒ–æ£€æµ‹
- âœ… çŠ¶æ€è¿ç§»å®Œæ•´æ€§
- âœ… IP çº§åˆ« welcomed é€»è¾‘
- âœ… å¤šæ¬¡ç«¯å£å˜åŒ–å¤„ç†

## é¢„æœŸæ•ˆæœ

1. **è§£å†³é‡å¤å¼€åœºç™½é—®é¢˜**ï¼šåŒä¸€ IP çš„ç«¯å£å˜åŒ–ä¸ä¼šè§¦å‘æ–°çš„å¼€åœºç™½
2. **ä¿æŒä¼šè¯è¿ç»­æ€§**ï¼šæ‰€æœ‰å®¢æˆ·ç«¯çŠ¶æ€åœ¨ç«¯å£å˜åŒ–æ—¶æ— ç¼è¿ç§»
3. **æ”¯æŒç½‘ç»œç¯å¢ƒå˜åŒ–**ï¼šé€‚åº” NATã€ä»£ç†ç­‰ç½‘ç»œç¯å¢ƒçš„ç«¯å£å˜åŒ–
4. **å‘åå…¼å®¹**ï¼šä¸å½±å“ç°æœ‰çš„å•ç«¯å£å®¢æˆ·ç«¯

## å…³é”®æ”¹è¿›ç‚¹

- ğŸ¯ **æ ¹æœ¬è§£å†³**ï¼šä½¿ç”¨ IP è€Œä¸æ˜¯ç«¯å£ä½œä¸ºå®¢æˆ·ç«¯æ ‡è¯†
- ğŸ”„ **æ— ç¼è¿ç§»**ï¼šç«¯å£å˜åŒ–æ—¶è‡ªåŠ¨è¿ç§»æ‰€æœ‰çŠ¶æ€
- ğŸ›¡ï¸ **ä¼šè¯ä¿æŠ¤**ï¼šä¿æŒ AI å¯¹è¯çš„è¿ç»­æ€§
- ğŸ“¡ **ç½‘ç»œé€‚åº”**ï¼šé€‚åº”å„ç§ç½‘ç»œç¯å¢ƒçš„ç«¯å£å˜åŒ–è¡Œä¸º
